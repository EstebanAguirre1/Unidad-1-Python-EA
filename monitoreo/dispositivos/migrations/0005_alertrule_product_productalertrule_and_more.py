# Generated by Django 5.1.1 on 2025-09-25 17:59

import django.db.models.deletion
from django.db import migrations, models


class Migration(migrations.Migration):

    dependencies = [
        ('dispositivos', '0004_device_image'),
    ]

    operations = [
        migrations.CreateModel(
            name='AlertRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('status', models.CharField(choices=[('ACTIVE', 'Active'), ('INACTIVE', 'Inactive')], default='ACTIVE', max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('name', models.CharField(max_length=140)),
                ('severity', models.CharField(choices=[('CRITICAL', 'Critical'), ('HIGH', 'High'), ('MEDIUM', 'Medium'), ('LOW', 'Low')], default='MEDIUM', help_text='Nivel de severidad de la alerta.', max_length=10)),
                ('unit', models.CharField(default='kWh', help_text='Unidad por defecto (kWh, W, A, etc.).', max_length=32)),
                ('default_min_threshold', models.FloatField(blank=True, help_text='Umbral mínimo por defecto.', null=True)),
                ('default_max_threshold', models.FloatField(blank=True, help_text='Umbral máximo por defecto.', null=True)),
            ],
            options={
                'db_table': 'alert_rule',
                'ordering': ['name'],
            },
        ),
        migrations.CreateModel(
            name='Product',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('status', models.CharField(choices=[('ACTIVE', 'Active'), ('INACTIVE', 'Inactive')], default='ACTIVE', max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('name', models.CharField(max_length=160)),
                ('sku', models.CharField(help_text='Código único de inventario (SKU).', max_length=80, unique=True)),
                ('manufacturer', models.CharField(blank=True, max_length=120)),
                ('model_name', models.CharField(blank=True, max_length=120)),
                ('description', models.TextField(blank=True)),
                ('nominal_voltage_v', models.FloatField(blank=True, null=True)),
                ('max_current_a', models.FloatField(blank=True, null=True)),
                ('standby_power_w', models.FloatField(blank=True, null=True)),
                ('category', models.ForeignKey(help_text='Categoría del producto.', on_delete=django.db.models.deletion.PROTECT, related_name='products', to='dispositivos.category')),
            ],
            options={
                'verbose_name': 'Product',
                'verbose_name_plural': 'Products',
                'db_table': 'product',
            },
        ),
        migrations.CreateModel(
            name='ProductAlertRule',
            fields=[
                ('id', models.BigAutoField(auto_created=True, primary_key=True, serialize=False, verbose_name='ID')),
                ('status', models.CharField(choices=[('ACTIVE', 'Active'), ('INACTIVE', 'Inactive')], default='ACTIVE', max_length=10)),
                ('created_at', models.DateTimeField(auto_now_add=True)),
                ('updated_at', models.DateTimeField(auto_now=True)),
                ('deleted_at', models.DateTimeField(blank=True, null=True)),
                ('min_threshold', models.FloatField(blank=True, help_text='Umbral mínimo (override).', null=True)),
                ('max_threshold', models.FloatField(blank=True, help_text='Umbral máximo (override).', null=True)),
                ('unit_override', models.CharField(blank=True, help_text='Unidad específica (opcional).', max_length=32, null=True)),
                ('alert_rule', models.ForeignKey(help_text='Regla de alerta aplicada a este producto.', on_delete=django.db.models.deletion.CASCADE, related_name='product_alert_links', to='dispositivos.alertrule')),
                ('product', models.ForeignKey(help_text='Producto al que se aplica la alerta con umbrales específicos.', on_delete=django.db.models.deletion.CASCADE, related_name='product_alert_links', to='dispositivos.product')),
            ],
            options={
                'db_table': 'product_alert_rule',
                'ordering': ['product_id', 'alert_rule_id'],
            },
        ),
        migrations.AddField(
            model_name='alertrule',
            name='products',
            field=models.ManyToManyField(blank=True, help_text='Productos a los que aplica esta regla (relación N:M con umbrales por producto).', related_name='alert_rules', through='dispositivos.ProductAlertRule', to='dispositivos.product'),
        ),
        migrations.AddIndex(
            model_name='product',
            index=models.Index(fields=['name'], name='product_name_c4c985_idx'),
        ),
        migrations.AddIndex(
            model_name='product',
            index=models.Index(fields=['sku'], name='product_sku_afe0af_idx'),
        ),
        migrations.AddIndex(
            model_name='productalertrule',
            index=models.Index(fields=['product'], name='product_ale_product_01a756_idx'),
        ),
        migrations.AddIndex(
            model_name='productalertrule',
            index=models.Index(fields=['alert_rule'], name='product_ale_alert_r_acd589_idx'),
        ),
        migrations.AddIndex(
            model_name='productalertrule',
            index=models.Index(fields=['product', 'alert_rule'], name='product_ale_product_fca7e0_idx'),
        ),
        migrations.AddConstraint(
            model_name='productalertrule',
            constraint=models.UniqueConstraint(fields=('product', 'alert_rule'), name='uix_product_alert_unique'),
        ),
        migrations.AddConstraint(
            model_name='productalertrule',
            constraint=models.CheckConstraint(condition=models.Q(('min_threshold__isnull', True), ('max_threshold__isnull', True), ('min_threshold__lte', models.F('max_threshold')), _connector='OR'), name='par_min_lte_max'),
        ),
        migrations.AddIndex(
            model_name='alertrule',
            index=models.Index(fields=['severity'], name='alert_rule_severit_cc978d_idx'),
        ),
        migrations.AddIndex(
            model_name='alertrule',
            index=models.Index(fields=['name'], name='alert_rule_name_3749b7_idx'),
        ),
        migrations.AddConstraint(
            model_name='alertrule',
            constraint=models.CheckConstraint(condition=models.Q(('default_min_threshold__isnull', True), ('default_max_threshold__isnull', True), ('default_min_threshold__lte', models.F('default_max_threshold')), _connector='OR'), name='alert_rule_default_min_lte_max'),
        ),
        migrations.AlterUniqueTogether(
            name='alertrule',
            unique_together={('name', 'severity')},
        ),
    ]
